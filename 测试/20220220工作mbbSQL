--同一发令日的时候是按照timestamp来判断哪一条最新吗


SELECT  R.COMPANYID,R.ANNOUCEDAY,R.EMP_CD
,(select MAX(ANNOUCEDAY) FROM empcostfuncif
WHERE empcostfuncif.COSTBURDEN_CD IS NOT NULL   
AND empcostfuncif.COMPANYID = R.COMPANYID
AND empcostfuncif.EMP_CD = R.EMP_CD
AND empcostfuncif.ANNOUCEDAY <= R.ANNOUCEDAY
) as PRE_MAX_ANNOUCEDAY_FOR_COST
,CASE when R.COSTBURDEN_CD IS NOT NULL THEN R.COSTBURDEN_CD ELSE
	(SELECT MAX(COSTBURDEN_CD) FROM empcostfuncif WHERE empcostfuncif.ANNOUCEDAY = PRE_MAX_ANNOUCEDAY_FOR_COST)
END COST
,(select MAX(ANNOUCEDAY) FROM empcostfuncif
WHERE empcostfuncif.FUNCTION_CD IS NOT NULL   
AND empcostfuncif.COMPANYID = R.COMPANYID
AND empcostfuncif.EMP_CD = R.EMP_CD
AND empcostfuncif.ANNOUCEDAY <= R.ANNOUCEDAY
) as PRE_MAX_ANNOUCEDAY_FOR_FUNCTION
,CASE when R.FUNCTION_CD IS NOT NULL THEN R.FUNCTION_CD ELSE
	(SELECT MAX(FUNCTION_CD) FROM empcostfuncif WHERE empcostfuncif.ANNOUCEDAY = PRE_MAX_ANNOUCEDAY_FOR_FUNCTION)
END FUNCTION_CD
,(select MAX(ANNOUCEDAY) FROM empcostfuncif
WHERE empcostfuncif.ENTERDAY IS NOT NULL   
AND empcostfuncif.COMPANYID = R.COMPANYID
AND empcostfuncif.EMP_CD = R.EMP_CD
AND empcostfuncif.ANNOUCEDAY <= R.ANNOUCEDAY
) as PRE_MAX_ANNOUCEDAY_FOR_ENTERDAY
,CASE when R.ENTERDAY IS NOT NULL THEN R.ENTERDAY ELSE
	(SELECT MAX(ENTERDAY) FROM empcostfuncif WHERE empcostfuncif.ANNOUCEDAY = PRE_MAX_ANNOUCEDAY_FOR_ENTERDAY)
END ENTERDAY
,(select MAX(ANNOUCEDAY) FROM empcostfuncif
WHERE empcostfuncif.RETIREDAY IS NOT NULL   
AND empcostfuncif.COMPANYID = R.COMPANYID
AND empcostfuncif.EMP_CD = R.EMP_CD
AND empcostfuncif.ANNOUCEDAY <= R.ANNOUCEDAY
) as PRE_MAX_ANNOUCEDAY_FOR_RETIREDAY
,CASE when R.RETIREDAY IS NOT NULL THEN R.RETIREDAY ELSE
	(SELECT MAX(RETIREDAY) FROM empcostfuncif WHERE empcostfuncif.ANNOUCEDAY = PRE_MAX_ANNOUCEDAY_FOR_RETIREDAY)
END RETIREDAY
,(select MAX(ANNOUCEDAY) FROM empvisitif
WHERE /*empvisitif.VISIT_CD <> '00' 
AND */empvisitif.COMPANYID = R.COMPANYID
AND empvisitif.EMP_CD = R.EMP_CD
AND empvisitif.ANNOUCEDAY <= R.ANNOUCEDAY
) as PRE_MAX_ANNOUCEDAY_FOR_VISIT_CD
,CASE when R.VISIT_CD  <> '00' THEN R.VISIT_CD ELSE
	(SELECT MAX(VISIT_CD) FROM empvisitif WHERE empvisitif.ANNOUCEDAY = PRE_MAX_ANNOUCEDAY_FOR_VISIT_CD)
END VISIT_CD
FROM 
(
SELECT A.COMPANYID,A.ANNOUCEDAY,A.EMP_CD,A.COSTBURDEN_CD,A.FUNCTION_CD,A.ENTERDAY,A.RETIREDAY,  
IF (VISIT_CD IS NULL , '00' , VISIT_CD ) AS VISIT_CD
from empcostfuncif A
LEFT join  `empvisitif` B
on A.COMPANYID = B.companyid
AND A.ANNOUCEDAY = B.ANNOUCEDAY
AND A.EMP_CD = B.EMP_CD
UNION ALL
SELECT B.COMPANYID,B.ANNOUCEDAY,B.EMP_CD,A.COSTBURDEN_CD,A.FUNCTION_CD,A.ENTERDAY,A.RETIREDAY,  B.VISIT_CD from empcostfuncif A
RIGHT join  `empvisitif` B
on A.COMPANYID = B.companyid
AND A.ANNOUCEDAY = B.ANNOUCEDAY
AND A.EMP_CD = B.EMP_CD
) R
ORDER BY R.COMPANYID,R.EMP_CD,R.ANNOUCEDAY
